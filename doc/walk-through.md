# A walk-through of the most common use case for muscle, musclefs, and snapshotsfs

## What we'll do

We'll set up musclefs in two hosts, darkstar and planck, which are two blank VMs created just for this demonstration. 

We'll make changes in the first host, darkstar, and show how that results in different revisions being created, and how they are related in the history and accessible via snapshotsfs.

We'll then switch to the second host, planck, do some changes there, and then go back to darkstar and merge in the changes done in planck.

This covers the most frequent commands and uses of musclefs and snapshotfs that I find useful day to day.

## Setting up darkstar

Let's ssh into the first host, darkstar, and set up muscle. We first have to create the mount points.

```
ng@darkstar:~$ ssh darkstar
ng@darkstar:~$ sudo mkdir /mnt/muscle /mnt/snapshots
ng@darkstar:~$ sudo chown ng:ng /mnt/muscle /mnt/snapshots
```

Then we issue

```
ng@darkstar:~$ muscle init
```

which creates a configuration file $HOME/lib/muscle/config with default settings. The configuration file is in JSON format, and below are the initial contents.

```
{
	"listen-ip": "127.0.0.1",
	"listen-port": 60512,
	"snapshotsfs-listen-ip": "127.0.0.1",
	"snapshotsfs-listen-port": 64277,
	"musclefs-mount": "/mnt/muscle",
	"snapshotsfs-mount": "/mnt/snapshots",
	"encryption-key": "efbe75f649c25d5269aee57c9738ac63628301f2720c0ddb178e6f9d1d5a9d00",
	"instance": "darkstar",
	"storage": "disk",
	"s3-profile": "",
	"s3-region": "",
	"s3-bucket": "",
	"disk-store-dir": "permanent",
	"read-only-instances": null
}
```

These default settings specify a disk-based permanent store (see *storage* property), with data at a directory called permanent within $HOME/lib/muscle (see *disk-store-dir* property).

While this may be good for some use cases and for experimenting, normally one would need to make blobs available across a network, possibly the internet, if more nodes need to use the file system. Therefore, we'll adjust the configuration to use an Amazon S3 bucket to store objects permanently.

We'll also change the ports (here randomly generated) and the *read-only-instances* property, which is a list of instances whose revisions are accessible via snapshotsfsâ€”this will be shown later later.

Finally, note that the encryption key, randomly generated by muscle init, is not something you'd put in a wiki!

Below are the contents of the configuration for darkstar after editing.

```
{
	"listen-ip": "127.0.0.1",
	"listen-port": 2023,
	"snapshotsfs-listen-ip": "127.0.0.1",
	"snapshotsfs-listen-port": 2029,
	"musclefs-mount": "/mnt/muscle",
	"snapshotsfs-mount": "/mnt/snapshots",
	"encryption-key": "0d649a51776b9c3bb00e909c9f999a4917e59134302d3edf00ef230ee5e61660",
	"instance": "darkstar",
	"storage": "s3",
	"s3-profile": "walkthrough",
	"s3-region": "eu-west-1",
	"s3-bucket": "musclefs-walkthrough",
	"read-only-instances": [ "darkstar", "planck" ]
}
```

The *s3-profile* property names a profile that's looked up in $HOME/.aws/credentials for credentials. Ideally these would correspond to an IAM user with exclusive access to the musclefs-walkthrough bucket.

At this point we can start musclefs, which will listen on localhost:2023 and serve the file system using the 9P protocol.

```
ng@darkstar:~$ musclefs &
```

To mount it, we can get a hint from muscle itself, by running muscle mount, as seen below.

```
ng@darkstar:~$ muscle mount
## Sweep and send as appropriate:
sudo mount 127.0.0.1 /mnt/muscle -t 9p -o 'trans=tcp,port=2023,dfltuid=1000,dfltgid=1000,uname=ng,access=any'
sudo mount 127.0.0.1 /mnt/snapshots -t 9p -o 'trans=tcp,port=2029,dfltuid=1000,dfltgid=1000,uname=ng,access=any'
9pfuse 127.0.0.1:2023 /mnt/muscle
9pfuse 127.0.0.1:2029 /mnt/snapshots
```

We'll mount musclefs using the Linux 9P kernel driver, so we'll use the first command.

```
ng@darkstar:~$ sudo mount 127.0.0.1 /mnt/muscle -t 9p -o 'trans=tcp,port=2023,dfltuid=1000,dfltgid=1000,uname=ng,access=any'
ng@darkstar:~$ mount | grep 9p
127.0.0.1 on /mnt/muscle type 9p (rw,relatime,sync,dirsync,trans=tcp,port=2023,dfltuid=1000,dfltgid=1000,uname=ng,access=any)
```

The file system only contains an empty control file at this stage.

```
ng@darkstar:~$ ls -l /mnt/muscle
total 0
-rw------- 1 ng ng 0 Nov  2 07:29 ctl
```

The control file will later be used to issue commands to the file system.

## Making changes on darkstar

We go ahead and create a hello world program, on darkstar. This is ordinary use of a file system, so we won't show it, we'll just show the end result below.

```
ng@darkstar:/mnt/muscle/hello$ find .
.
./main.go
./hello
ng@darkstar:/mnt/muscle/hello$ ./hello
Ciao, world.
```

Let's now take a snapshot of the file system on darkstar, or, in other words, create a new revision (I use the terms interchangeably). We do so via the control file, and we can verify it happened via the muscle history command.

```
ng@darkstar:/mnt/muscle$ echo snapshot >ctl
ng@darkstar:/mnt/muscle$ cat ctl
snapshot
ng@darkstar:/mnt/muscle$ muscle history local
revision taken 2s ago, precisely 2019-11-02 07:14:17 -0400 EDT
instance darkstar
host darkstar
key 70197eda7570a4802f6d708e9712fcbe84fe1da14311b45daa7075ff7fb710ed
parents
root 1a16f071ad7a6ea2cc178354cd617d5bbf6180ab6a5cc3e60cd47e791ac26d1a
```

This shows a revision 70197eda with no parents (it's the initial commit, so to speak) and with root 1a16f071. The pointer to the current revision is stored in a file, as shown below. This is the entry point to the file system.

```
ng@darkstar:/mnt/muscle$ cat $HOME/lib/muscle/root ; echo
70197eda7570a4802f6d708e9712fcbe84fe1da14311b45daa7075ff7fb710ed
```

## Making further changes and working with the history

Let's minimally change the hello world program.

```
ng@darkstar:/mnt/muscle/hello$ sed -i -e 's/Ciao/Hello/' main.go
ng@darkstar:/mnt/muscle/hello$ go build -v
ng@darkstar:/mnt/muscle/hello$ ./hello
Hello, world.
```

Happy with our results, we take another snapshot of our work, and look again at the history. We'll see that the new revision, at the top, now has a parent, which is the revision at the bottom. We'll toggle the -d switch to muscle history, to display the diff between the two revisions. (There are a few other options to muscle history, see muscle history -help.)

```
ng@darkstar:/mnt/muscle$ echo snapshot >ctl
ng@darkstar:/mnt/muscle$ cat ctl
snapshot
snapshot
ng@darkstar:/mnt/muscle$ muscle history -d local
revision taken 26s ago, precisely 2019-11-02 07:16:24 -0400 EDT
instance darkstar
host darkstar
key 360c702940ad89e64939ec9758fa53f4e01c0a8665438b279f11befb991f1166
parents c65384cbfc76828e761c0ddddbd078099b0530866004f882b1f6c870e6086884
root 6b10e5a743326eeaca05627aeaaf45e6766361450d8c48685e3b030a45f65a86

------ a revision c65384cbfc76828e761c0ddddbd078099b0530866004f882b1f6c870e6086884 root 1a16f071ad7a6ea2cc178354cd617d5bbf6180ab6a5cc3e60cd47e791ac26d1a
++++++ b revision 390bdf4602a4bcb8e0c0e9bc0ea9b5d4aef99724125c89e6c1d2f2c951cfcbbc root 6b10e5a743326eeaca05627aeaaf45e6766361450d8c48685e3b030a45f65a86
omitting diff for large node: 2008801: tree node too large
--- a/root/hello/main.go
+++ b/root/hello/main.go
@@ -3,5 +3,5 @@
 import "fmt"
 
 func main() {
-	fmt.Println("Ciao, world.")
+	fmt.Println("Hello, world.")
 }

revision taken 2m33s ago, precisely 2019-11-02 07:14:17 -0400 EDT
instance darkstar
host darkstar
key c65384cbfc76828e761c0ddddbd078099b0530866004f882b1f6c870e6086884
parents
root 1a16f071ad7a6ea2cc178354cd617d5bbf6180ab6a5cc3e60cd47e791ac26d1a
```

## Accessing many revisions at once

To access revisions other than the current one, we use snapshotsfs, another 9P file server. Let's start it and mount it using the Linux 9P kernel driver.

```
ng@darkstar:~$ snapshotsfs &
ng@darkstar:~$ muscle mount
... omitted, same as above ...
ng@darkstar:~$ sudo mount 127.0.0.1 /mnt/snapshots -t 9p -o 'trans=tcp,port=2029,dfltuid=1000,dfltgid=1000,uname=ng,access=any'
ng@darkstar:~$ mount | grep 9p
127.0.0.1 on /mnt/muscle type 9p (rw,relatime,sync,dirsync,trans=tcp,port=2023,dfltuid=1000,dfltgid=1000,uname=ng,access=any)
127.0.0.1 on /mnt/snapshots type 9p (rw,relatime,sync,dirsync,trans=tcp,port=2029,dfltuid=1000,dfltgid=1000,uname=ng,access=any)
```

The output of find below shows that snapshotsfs has one directory per instance (remember the *read-only-instances* configuration property) and within each instance, one directory per revision. These directories are timestamps rather than sha256 hashes.

```
ng@darkstar:~$ find /mnt/snapshots
/mnt/snapshots
/mnt/snapshots/darkstar
/mnt/snapshots/darkstar/2019-11-02T07-16
/mnt/snapshots/darkstar/2019-11-02T07-16/ctl
/mnt/snapshots/darkstar/2019-11-02T07-16/hello
/mnt/snapshots/darkstar/2019-11-02T07-16/hello/main.go
/mnt/snapshots/darkstar/2019-11-02T07-16/hello/hello
/mnt/snapshots/darkstar/2019-11-02T07-14
/mnt/snapshots/darkstar/2019-11-02T07-14/ctl
/mnt/snapshots/darkstar/2019-11-02T07-14/hello
/mnt/snapshots/darkstar/2019-11-02T07-14/hello/main.go
/mnt/snapshots/darkstar/2019-11-02T07-14/hello/hello
/mnt/snapshots/planck
```

Instead of muscle history -d, we could have used the system diff and snapshotsfs, like we do below.

```
ng@darkstar:/mnt/snapshots/darkstar$ diff -u ./2019-11-02T07-14/hello/main.go ./2019-11-02T07-16/hello/main.go
--- ./2019-11-02T07-14/hello/main.go	2019-11-02 07:18:41.000000000 -0400
+++ ./2019-11-02T07-16/hello/main.go	2019-11-02 07:18:41.000000000 -0400
@@ -3,5 +3,5 @@
 import "fmt"
 
 func main() {
-	fmt.Println("Ciao, world.")
+	fmt.Println("Hello, world.")
 }
```

It is also possible to "walk a revision into existence". This is shown below, where we get a revision key from the history, and then walk into a directory named like the revision key, even though it does not exist. That walk operation links the revision into the snapshotsfs file system. That's handy for exploring older revisions that one finds via muscle history.

```
ng@darkstar:~$ muscle history local | grep ^key
key 03b78da6344a53c244ab51b697cb7a947ddeef18b499bc957baaa65aeb2b2c61
key 390bdf4602a4bcb8e0c0e9bc0ea9b5d4aef99724125c89e6c1d2f2c951cfcbbc
key c65384cbfc76828e761c0ddddbd078099b0530866004f882b1f6c870e6086884
ng@darkstar:~$ cd /mnt/snapshots/c65384cbfc76828e761c0ddddbd078099b0530866004f882b1f6c870e6086884
ng@darkstar:/mnt/snapshots/c65384cbfc76828e761c0ddddbd078099b0530866004f882b1f6c870e6086884$ grep Print hello/main.go
	fmt.Println("Ciao, world.")
```

In summary, so far we've seen that the musclefs is git-like, where many revisions can be explored at once via snapshotsfs.

It may not seem that muscle has a reason to be, since what we've seen so far can be accomplished with a git repository.

A problem with the latter approach is that git repositories become very slow after a certain size (which, I admit, I haven't determined, but I've seen massive monorepos where git was impossible to use and other mechanisms had to be found).

Also, if you were to use a git repository as a versioned file system, you'd have to have a copy of all the history of the repository in every participating machine, while in muscle the data is permanently persisted in an S3 bucket, and a subset of the blobs are kept also locally for speed of operation and for disconnected operation. That could even represent a fraction of the data in musclefs. For instance, I'm pretty sure most of my videos were never accessed from my work machine, therefore the corresponding blobs won't ever have been downloaded there.

Lastly, sometimes, instead of having a separate instance (as we'll see below), you'd expose the 9P file server over a *private* network, to mount the instance directly on other machines. I do this with a number of VMs that live within the same virtual network within one host. Careful though, because, despite all muscle blobs being encrypted, data travels in the clear via 9P.

## Forking an instance

We'll now set up a second instance of musclefs, on the planck host, making a fork of darkstar's most recent revision.

We'll skip over the part where we set up the mount points and the configuration file on planck. We'll just note that the only difference in configuration is the instance name,

```
ng@planck:~/lib/muscle$ diff config.darkstar config
9c9
< 	"instance": "darkstar",
---
> 	"instance": "planck",
```

in particular, darkstar and planck share the same permanent store (the S3 bucket called *musclefs-walkthrough*).

The muscle fork command, shown below, creates a new instance from an existing one. The subsequent muscle history command shows the result of the fork, which is, a new revision for the planck instance, with darkstar's most recent instance as the parent. Note that the root hash pointer is the same, i.e., planck and darkstar will have the same contents initially.

```
ng@planck:~$ muscle fork darkstar planck
ng@planck:~$ muscle history planck
revision taken 21s ago, precisely 2019-11-02 07:23:44 -0400 EDT
instance planck
host planck
key 4c87ba6cfed83da3a4a04f6feb19475b0a92398f2514178a875b719123f27177
parents 390bdf4602a4bcb8e0c0e9bc0ea9b5d4aef99724125c89e6c1d2f2c951cfcbbc
root 6b10e5a743326eeaca05627aeaaf45e6766361450d8c48685e3b030a45f65a86

revision taken 7m41s ago, precisely 2019-11-02 07:16:24 -0400 EDT
instance darkstar
host darkstar
key 390bdf4602a4bcb8e0c0e9bc0ea9b5d4aef99724125c89e6c1d2f2c951cfcbbc
parents c65384cbfc76828e761c0ddddbd078099b0530866004f882b1f6c870e6086884
root 6b10e5a743326eeaca05627aeaaf45e6766361450d8c48685e3b030a45f65a86
```

The only thing left to initialize the fork in the host is to write the root key file, start musclefs and mount it.

```
ng@planck:~$ echo -n 4c87ba6cfed83da3a4a04f6feb19475b0a92398f2514178a875b719123f27177 > lib/muscle/root
ng@planck:~$ musclefs &
ng@planck:~$ muscle mount
... omitted, similar as before ...
ng@planck:~$ sudo mount 127.0.0.1 /mnt/muscle -t 9p -o 'trans=tcp,port=2023,dfltuid=1000,dfltgid=1000,uname=ng,access=any'
```

Let's verify we have the files that we added on darkstar:

```
ng@planck:~$ find /mnt/muscle
/mnt/muscle/
/mnt/muscle/ctl
/mnt/muscle/hello
/mnt/muscle/hello/main.go
/mnt/muscle/hello/hello
ng@planck:~$ /mnt/muscle/hello/hello
Hello, world.
```

We can now make changes in planck, and create a new revision. I'll skip some steps here, since we've already covered the operations involved.

```
ng@planck:~$ cd /mnt/muscle
ng@planck:/mnt/muscle$ mkdir mycat
ng@planck:/mnt/muscle$ cd mycat
ng@planck:/mnt/muscle/mycat$ ed main.go
...
ng@planck:/mnt/muscle/mycat$ go build -v
_/mnt/muscle/mycat
ng@planck:/mnt/muscle/mycat$ echo foobar | ./mycat
foobar
ng@planck:/mnt/muscle/mycat$ cd ..
ng@planck:/mnt/muscle$ echo snapshot >ctl
```

Note that, in practice, one puts the last command into cron to execute at the required frequency, so one has automatic snapshots.

Before leaving planck, let's confirm the history is as we expect, that is, we added a top-level directory called mycat.

```
ng@planck:~$ muscle history -n 2 -d local
revision taken 6s ago, precisely 2019-11-02 07:28:03 -0400 EDT
instance planck
host planck
key 72ff2057effa3ece669cd58f2285d8b3e86d31c14039df1da7e8a5fb6811b12c
parents 4c87ba6cfed83da3a4a04f6feb19475b0a92398f2514178a875b719123f27177
root f44e03788c0e565863325275a695d4acd6ee055a64da58743e5899e233e44bd2

------ a revision 4c87ba6cfed83da3a4a04f6feb19475b0a92398f2514178a875b719123f27177 root 6b10e5a743326eeaca05627aeaaf45e6766361450d8c48685e3b030a45f65a86
++++++ b revision 72ff2057effa3ece669cd58f2285d8b3e86d31c14039df1da7e8a5fb6811b12c root f44e03788c0e565863325275a695d4acd6ee055a64da58743e5899e233e44bd2
--- /dev/null
+++ b/root/mycat

revision taken 4m25s ago, precisely 2019-11-02 07:23:44 -0400 EDT
instance planck
host planck
key 4c87ba6cfed83da3a4a04f6feb19475b0a92398f2514178a875b719123f27177
parents 390bdf4602a4bcb8e0c0e9bc0ea9b5d4aef99724125c89e6c1d2f2c951cfcbbc
root 6b10e5a743326eeaca05627aeaaf45e6766361450d8c48685e3b030a45f65a86
```

In summary, we branched planck from darkstar, made some changes, so that now planck is ahead of darkstar.

The next step is to merge back the changes.

## Merging changes from another instance

Let's go back to darkstar to merge the changes done in planck. (In real-world terms, this could be me getting home from work, and merging back changes into my home workstation. Or the converse, in the morning.) The relevant command here is muscle merge, which will output a series of possible commands to run to effect the merge.

```
ng@darkstar:~$ muscle merge planck
echo graft 58c5b4bb8b50cca1ac16ea503dfc489a10c5458694a9a9f19c3dca433617f37f/mycat mycat > /mnt/muscle/ctl
echo flush > /mnt/muscle/ctl
## If all is merged fine, run the following to create a merge commit.
## echo snapshot 58c5b4bb8b50cca1ac16ea503dfc489a10c5458694a9a9f19c3dca433617f37f > /mnt/muscle/ctl
```

The first command is a graft, which links a node from another revision, 58c5b4bb, to the local tree. This makes sense, since this was added in the planck host and never existed in darkstar. The last command, creates a revision with an additional parent 58c5b4bb, besides the current local revision. Let's run all these and then check the history.

```
ng@darkstar:~$ echo graft 58c5b4bb8b50cca1ac16ea503dfc489a10c5458694a9a9f19c3dca433617f37f/mycat mycat > /mnt/muscle/ctl
ng@darkstar:~$ echo flush > /mnt/muscle/ctl
ng@darkstar:~$ echo snapshot 58c5b4bb8b50cca1ac16ea503dfc489a10c5458694a9a9f19c3dca433617f37f > /mnt/muscle/ctl
ng@darkstar:~$ muscle history -n 1 local
revision taken 8s ago, precisely 2019-11-02 07:29:36 -0400 EDT
instance darkstar
host darkstar
key 8af089648a196429fbfd8588b422da5be1a248c23cdb5458d7f82d3ca95e41f6
parents 58c5b4bb8b50cca1ac16ea503dfc489a10c5458694a9a9f19c3dca433617f37f 390bdf4602a4bcb8e0c0e9bc0ea9b5d4aef99724125c89e6c1d2f2c951cfcbbc
root 54a02de5be7ca8e4a73b38df6f4be90f9d47946628e0fb0f74937cbe69d639c4
```

Note the two parents, the latter being the local (darkstar) one.

The muscle merge command needs to find a merge base, and while doing that, a dot file is generated in the system's temporary directory, for visibility. There is also an explicit diagnostic command to just find the merge base and produce such dot file, shown below.

```
ng@planck:~$ muscle merge-base darkstar planck
darkstar:30f87e6300d6c94397198b4b2e3125314400df003637e8c6d55814381438c351
planck:58c5b4bb8b50cca1ac16ea503dfc489a10c5458694a9a9f19c3dca433617f37f
58c5b4bb8b50cca1ac16ea503dfc489a10c5458694a9a9f19c3dca433617f37f
```

In this case, we see that the merge-base for darkstar and planck is planck itself, which makes perfect sense, since we've just created the revision on darkstar having planck as one of its parents.

Here are the generated graphs. The first comes from the merge command, where the merge base is found.

![mm1](https://github.com/nicolagi/muscle/wiki/images/wt_267901580.dot.png)

This is after the graft and the flush, which shows an additional revision for darkstar.

![mm2](https://github.com/nicolagi/muscle/wiki/images/wt_048864547.dot.png)

This is after the snapshot command, where the merge-base is now trivially found, as the tip of darkstar points to the tip of planck.

![mb](https://github.com/nicolagi/muscle/wiki/images/wt_908409408.dot.png)

